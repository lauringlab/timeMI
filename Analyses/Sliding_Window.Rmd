---
title: "Sliding_Window"
author: "Sarah Arcos"
date: "2022-11-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(Biostrings)
library(weightedMI)
library(data.table)
```

# Calculate MI for H3N2 polymerase using 5-year sligind windows

## Read in data

```{r}
seq_times <- readRDS("../data/seq_times_091122.rda")
pol <- readAAStringSet("../../H3N2_Processing/pol_aa.fasta") %>%
  as.matrix
```

## Get start of each window

```{r}
start_years <- seq(min(seq_times$date), (max(seq_times$date) - 4))
```

## Define function to get sequences in each window

```{r}
get_window <- function(df, mat, start_year){
  window_df <- df %>%
    filter(date >= start_year & date < start_year+5)
  return(mat[window_df$rowname,])
}
```

## Calculate MI for each window

 - Uncomment code to actually run

```{r}
# window_results <- vector(mode = "list")
# 
# for (i in start_years){
#   window_results[[i]] <- get_window(seq_times, pol, i) %>%
#     calculateMI(ncores = 6)
#   print(paste("Done with window at", i))
# }
# 
# saveRDS(window_results, "../data/slidingWindows.rds")
```

## Plot MI of example residue pairs

```{r}
window_results <- readRDS("../data/slidingWindows.rds")
windows <- rbindlist(window_results, idcol = TRUE)

mi_iav_info <- readRDS("../data/mi_network_info.rds")
get_index <- function(pos){
  return(mi_iav_info[mi_iav_info$index == pos,]$id %>%
           str_replace("_", " "))
}
get_index_v <- Vectorize(get_index)

plot_example_mi <- function(v1, v2){
  
  window_example <- windows %>%
    filter(V1 == v1 & V2 == v2) %>%
    select(.id, Group, mi, mip, v1_entropy, v2_entropy) %>%
    full_join(tibble(.id = start_years), by = ".id") %>%
    complete(.id, Group, fill = list(mi = 0, mip = -Inf, v1_entropy = 0, v2_entropy = 0)) %>%
    filter(!is.na(Group))
  
  ggplot(window_example, aes(x = .id, y = mi)) +
    geom_line() +
    scale_y_continuous(breaks = c(0, 0.3, 0.6)) +
    theme_minimal() +
    labs(title = "Mutual Information (5-year sliding window)",
         subtitle = paste(get_index(v1), "and", get_index(v2)),
         x = "Date", y = "Mutual Information") +
    theme(text = element_text(size = 12))
}

plot_example_mi(1228, 1848)
plot_example_mi(938, 1346)
plot_example_mi(522, 1846)
plot_example_mi(227, 938)

```



