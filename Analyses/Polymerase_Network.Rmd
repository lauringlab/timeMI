---
title: "Polymerase_Network"
author: "Sarah Arcos"
date: "2022-11-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(weightedMI)
library(associationsubgraphs)
library(viridis)

source("../Plot_Frequencies.R")
```

# Calculate the equal-weighted MI for the H3N2 polymerase

## Read in data

```{r}
seq_times <- readRDS("../data/seq_times_091122.rda")

pol_groups <- seq_times %>%
  select(ID = rowname, group = date)

pol <- readMSA("../../H3N2_Processing/pol_aa.fasta")
```

## Calculate MI

 - Uncomment code to actually run
 - **Warning**: for H3N2 pol, takes ~45 min to 1 hour with ncores = 6

```{r}
# polMI <- calculateMI(pol, weighted = TRUE, groups = pol_groups,
#                      weights = "equal", ncores = 6)
# 
# saveRDS(polMI, "../data/h3n2pol_equalMI.rds")
```


## Generate Network Viz

 - Use associationsubgraphs package
 - Set default step to "min_max_rule"
 - Use mi_network_info to get readable index names

```{r}
polMI <- readRDS("../data/h3n2pol_equalMI.rds")
mi_network_info <- readRDS("../data/mi_network_info.rds")

polMI_IDs <- polMI %>%
  left_join(mi_network_info, by = c("V1" = "index")) %>%
  left_join(mi_network_info, by = c("V2" = "index")) %>%
  filter(z_score > 4) %>%
  select(a = "id.x", b = "id.y", strength = z_score)

# saveRDS(polMI_IDs,"/Users/sarcos/Desktop/Lauring Lab/MI_Networks_App/data/polMI.rds")

visualize_subgraph_structure(
  association_pairs = polMI_IDs,
  node_info = mi_network_info %>% select(-index),
  trim_subgraph_results = FALSE,
  default_step = "min_max_rule"
)

```



## Tally high-scoring MIp among polymerase subunits

 - "High-scoring" means z-score > 4

```{r}
polMI_tallys <- polMI_IDs  %>%
  mutate(grouping = paste(a,b, sep = ", ")) %>%
  mutate(grouping = str_remove_all(grouping, pattern = "_[0-9]*")) %>%
  count(grouping) %>%
  arrange(n) %>% 
  mutate(grouping = factor(grouping, levels = unique(grouping)))

ggplot(polMI_tallys, aes(x = grouping, y = n)) +
  geom_col(alpha = 0.7, fill = "grey") +
  theme_classic() +
  labs(title = "wMI pairs within and between polymerase proteins",
       x = "Group", y = "Count") +
  theme(text = element_text(size = 12),
        legend.position = "none")

# ggsave("../Figures/mip_pairs.pdf",
#        width = 5, height = 3)
```

## Plot amino acid frequencies for top subgraphs

```{r}
#Subgraph 1
plot_example_freqs(c(194, 227, 338, 569))
# ggsave("../Figures/freq_subgraph1.pdf",
#        width = 4, height = 3)

#Subgraph 2
plot_example_freqs(c(559, 697, 1828, 1859, 2073, 2089))
# ggsave("../Figures/freq_subgraph2.pdf",
#        width = 4, height = 4)
```


## Plot distribution of top MIp among groups

```{r}
polMI_groups <- polMI_IDs  %>%
  mutate(grouping = paste(a,b, sep = ", ")) %>%
  mutate(grouping = str_remove_all(grouping, pattern = "_[0-9]*"))

ggplot(polMI_groups, aes(x = factor(grouping, levels = polMI_tallys$grouping), y = log10(strength))) +
  geom_violin() +
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
               colour = "red") +
  theme_classic() +
  theme(text = element_text(size = 12),
        legend.position = "none")
```

## Percent of top wMI pairs between capB and endo domains of PB2

```{r}
polMI_endocap <- polMI %>%
  left_join(mi_network_info, by = c("V1" = "index")) %>%
  left_join(mi_network_info, by = c("V2" = "index")) %>%
  filter(z_score > 4) %>%
  filter((V1 >= 318 & V1 < 480) |
           (V2 >= 318 & V2 < 480) |
           (V1 >= (759+757) & V1 < (759+757+195)) |
           (V2 >= (759+757) & V2 < (759+757+195)))

nrow(polMI_endocap) / nrow(polMI_IDs)

#Percent of protein length that is endo or capB
((480 - 318) + 195) / (759+757+716)

```




